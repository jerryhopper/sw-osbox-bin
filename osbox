#!/bin/bash

## sw-osbox-bin
## JerryHopper - hopper.jerry@gmail.com


####################################################################################################
# osbox install function
if [ "$1" == "installservice" ]; then
  if [ "$2" == "enable" ]; then
    if [ -f /etc/systemd/system/osbox.service ]; then
        rm -rf /etc/systemd/system/osbox.service
    fi
    # Enable the installer service
    ln -s /usr/local/osbox/lib/systemd/osbox.service /etc/systemd/system/osbox.service
    systemctl enable osbox.service
    exit;
  fi
  if [ "$2" == "disable" ]; then
    if [ -f /etc/systemd/system/osbox.service ]; then
        rm -rf /etc/systemd/system/osbox.service
    fi
    # Enable the installer service
    systemctl daemon-reload
    exit;
  fi
  echo "Usage: "
  echo "  osbox installservice enable  - Enables the installerservice"
  echo "  osbox installservice disable - Disables the installerservice"
  exit
fi


####################################################################################################
if [ "$1" == "reset" ]; then
  if [ "$2" == "version" ]; then
    echo "0" /etc/osbox/.sw-osbox-bin.version
    echo "0" /etc/osbox/.sw-osbox-core.version
    bash /usr/local/osbox/bin/update.sh
  fi
  if [ "$2" == "database" ]; then
    rm -f /etc/osbox/osbox.db
    bash /usr/local/osbox/bin/update.sh
  fi

  #returnedstatus $? "success" "fail"
  echo "Usage: "
  echo "  osbox reset version  - resets the version and  runs update."
  echo "  osbox reset database - removes the database and runs update."
  echo "  osbox reset  - this message."
  exit
fi


####################################################################################################
if [ "$1" == "update" ]; then

  if [ "$2" == "latest" ];then
    if [ ! -f /etc/osbox/.dev ];then
        touch /etc/osbox/.dev
    fi
  fi
  if [ "$2" == "stable" ];then
    if [ -f /etc/osbox/.dev ];then
        rm -f /etc/osbox/.dev
    fi
  fi
  if [ "$2" == "?" ] || [ "$2" == "help" ];then
    echo "Usage: "
    echo "  osbox update  - Updates the application using current stable/latest setting"
    echo "  osbox update latest  - resets to stable updates and runs update."
    echo "  osbox update stable  - resets to latest unstable updates and runs update."
    echo "  osbox update ?/help  - this message."

    exit
  fi
  bash /usr/local/osbox/bin/update.sh
  bash /usr/local/osbox/project/sw-osbox-core/src/sh/database/update.sh
  #returnedstatus $? "success" "fail"
  systemctl daemon-reload
  exit
fi


####################################################################################################
## Run OSBOX core functionality.
if [ -f /usr/local/osbox/project/sw-osbox-core/osbox.sh ];then
  bash /usr/local/osbox/project/sw-osbox-core/osbox.sh $1 $2 $3 $4 $5 $6
fi
